{
  "hash": "025ceec74e3bbbf3883dd6e131ea1d66",
  "result": {
    "engine": "knitr",
    "markdown": "# Tidy Data {#sec-chapter}\n\n\n\n\n\n\n\n\n\n\n\n> ### Learning Objectives {.unnumbered}\n>\n> * Understand the concept of tidy data (wide and long formats).\n> * Be able to reshape data between long and wide formats.\n> * Understand the benefits of using tidy data for data manipulation, visualization, and analysis.\n\n## \"Wide\" and \"Long\" Formatted Data\n\nDatasets are usually structured in one of two ways:\n\n- **Wide** format: each variable has its own column\n- **Long** format: each observation has its own row\n\n<center>\n<img src=\"images/data-shapes.png\" width=500>\n</center>\n\n[[Source](https://tavareshugo.github.io/r-intro-tidyverse-gapminder/09-reshaping/index.html)]{.aside}\n\nTake a look at this example of a dataset on federal R&D spending by U.S. government department:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_wide <- read_csv(here('data', 'fed_spend_wide.csv'))\n\nhead(fed_spend_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 15\n#>    year   DHS   DOC   DOD   DOE   DOT   EPA   HHS Interior  NASA   NIH   NSF\n#>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>    <dbl> <dbl> <dbl> <dbl>\n#> 1  1976     0   819 35696 10882  1142   968  9226     1152 12513  8025  2372\n#> 2  1977     0   837 37967 13741  1095   966  9507     1082 12553  8214  2395\n#> 3  1978     0   871 37022 15663  1156  1175 10533     1125 12516  8802  2446\n#> 4  1979     0   952 37174 15612  1004  1102 10127     1176 13079  9243  2404\n#> 5  1980     0   945 37005 15226  1048   903 10045     1082 13837  9093  2407\n#> 6  1981     0   829 41737 14798   978   901  9644      990 13276  8580  2300\n#> # ℹ 3 more variables: Other <dbl>, USDA <dbl>, VA <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\nAs the name suggests, this dataset is in **wide** format, where each department is a column. \n\nCompare this to the **long** format:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_long <- read_csv(here('data', 'fed_spend_long.csv'))\n\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>   department  year rd_budget_mil\n#>   <chr>      <dbl>         <dbl>\n#> 1 DOD         1976         35696\n#> 2 NASA        1976         12513\n#> 3 DOE         1976         10882\n#> 4 HHS         1976          9226\n#> 5 NIH         1976          8025\n#> 6 NSF         1976          2372\n```\n\n\n:::\n:::\n\n\n\n\n\nThis is the same dataset, but in **long** format, where each observation has its own row. Here you will notice that the department names are now variables, and the R&D spending is a single column. The year is repeated for each department.\n\n**How do we know which format a dataset is in?**\n\nA helpful heuristic is to ask yourself:\n\n\n::: {.callout-tip}\n\n**Do the names describe the values?**\n\n:::\n\n- If **Yes**: \"Long\" format\n- If **No**: \"Wide\" format\n\n## Tidy data = \"Long\" format\n\nWhen we refer to \"tidy data\", we are referring to data in **long** format that follows the \"tidy\" principles:\n\n- Each **variable** has its own **column**\n- Each **observation** has its own **row**\n\n<center>\n<img src=\"images/tidy-data.png\" width = \"600\">\n</center>\n\nYou can verify that the federal spending dataset is in long format:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>   department  year rd_budget_mil\n#>   <chr>      <dbl>         <dbl>\n#> 1 DOD         1976         35696\n#> 2 NASA        1976         12513\n#> 3 DOE         1976         10882\n#> 4 HHS         1976          9226\n#> 5 NIH         1976          8025\n#> 6 NSF         1976          2372\n```\n\n\n:::\n:::\n\n\n\n\n\n## Reshaping data\n\nWe use the `pivot_longer()` and `pivot_wider()` functions to reshape data between long and wide formats.\n\n<center>\n<img src=\"images/data-pivot.png\" width=600>\n</center>\n\n[[Source](https://tavareshugo.github.io/r-intro-tidyverse-gapminder/09-reshaping/index.html)]{.aside}\n\n### From \"long\" to \"wide\" with `pivot_wider()`\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>   department  year rd_budget_mil\n#>   <chr>      <dbl>         <dbl>\n#> 1 DOD         1976         35696\n#> 2 NASA        1976         12513\n#> 3 DOE         1976         10882\n#> 4 HHS         1976          9226\n#> 5 NIH         1976          8025\n#> 6 NSF         1976          2372\n```\n\n\n:::\n:::\n\n\n\n\n\nTo convert to wide format, we need to specify which column to convert into the column names and which column to convert into the column values:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_wide <- fed_spend_long %>%\n  pivot_wider(\n    names_from = department,\n    values_from = rd_budget_mil\n  )\n\nhead(fed_spend_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 15\n#>    year   DOD  NASA   DOE   HHS   NIH   NSF  USDA Interior   DOT   EPA   DOC\n#>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>    <dbl> <dbl> <dbl> <dbl>\n#> 1  1976 35696 12513 10882  9226  8025  2372  1837     1152  1142   968   819\n#> 2  1977 37967 12553 13741  9507  8214  2395  1796     1082  1095   966   837\n#> 3  1978 37022 12516 15663 10533  8802  2446  1962     1125  1156  1175   871\n#> 4  1979 37174 13079 15612 10127  9243  2404  2054     1176  1004  1102   952\n#> 5  1980 37005 13837 15226 10045  9093  2407  1887     1082  1048   903   945\n#> 6  1981 41737 13276 14798  9644  8580  2300  1964      990   978   901   829\n#> # ℹ 3 more variables: DHS <dbl>, VA <dbl>, Other <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n### From \"wide\" to \"long\" with `pivot_longer()`\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(fed_spend_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 15\n#>    year   DOD  NASA   DOE   HHS   NIH   NSF  USDA Interior   DOT   EPA   DOC\n#>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>    <dbl> <dbl> <dbl> <dbl>\n#> 1  1976 35696 12513 10882  9226  8025  2372  1837     1152  1142   968   819\n#> 2  1977 37967 12553 13741  9507  8214  2395  1796     1082  1095   966   837\n#> 3  1978 37022 12516 15663 10533  8802  2446  1962     1125  1156  1175   871\n#> 4  1979 37174 13079 15612 10127  9243  2404  2054     1176  1004  1102   952\n#> 5  1980 37005 13837 15226 10045  9093  2407  1887     1082  1048   903   945\n#> 6  1981 41737 13276 14798  9644  8580  2300  1964      990   978   901   829\n#> # ℹ 3 more variables: DHS <dbl>, VA <dbl>, Other <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\nTo convert to long format, we need to create new column names for the names and values, and we also need to specify which columns to convert:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_long <- fed_spend_wide %>%\n  pivot_longer(\n    names_to = \"department\",\n    values_to = \"rd_budget_mil\",\n    cols = DOD:Other\n  )\n\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>    year department rd_budget_mil\n#>   <dbl> <chr>              <dbl>\n#> 1  1976 DOD                35696\n#> 2  1976 NASA               12513\n#> 3  1976 DOE                10882\n#> 4  1976 HHS                 9226\n#> 5  1976 NIH                 8025\n#> 6  1976 NSF                 2372\n```\n\n\n:::\n:::\n\n\n\n\n\nYou can also set `cols` by selecting which columns _not_ to use, like this:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_long <- fed_spend_wide %>%\n  pivot_longer(\n    names_to = \"department\",\n    values_to = \"rd_budget_mil\",\n    cols = -year\n  )\n\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>    year department rd_budget_mil\n#>   <dbl> <chr>              <dbl>\n#> 1  1976 DOD                35696\n#> 2  1976 NASA               12513\n#> 3  1976 DOE                10882\n#> 4  1976 HHS                 9226\n#> 5  1976 NIH                 8025\n#> 6  1976 NSF                 2372\n```\n\n\n:::\n:::\n\n\n\n\n\n## Tidy data wrangling\n\nThere's a good reason why we like to keep our data in a long (tidy) format: it lets us use a consistent set of functions for manipulating, summarizing, and visualizing data.\n\nHere's a quick explanation with cute graphics, by [Allison Horst](https://github.com/allisonhorst/stats-illustrations):\n\n<center>\n<img src=\"images/horst_tidydata_1.jpg\" width=500>\n<img src=\"images/horst_tidydata_2.jpg\" width=500>\n<img src=\"images/horst_tidydata_3.jpg\" width=500>\n</center>\n\n### Example 1: Total R&D spending in each year\n\nThis is a simple enough task, but with our data in wide format, we need to add each column manually like this:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_wide %>%\n  mutate(\n    total = DHS +\n      DOC +\n      DOD +\n      DOE +\n      DOT +\n      EPA +\n      HHS +\n      Interior +\n      NASA +\n      NIH +\n      NSF +\n      Other +\n      USDA +\n      VA\n  ) %>%\n  select(year, total)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 42 × 2\n#>    year total\n#>   <dbl> <dbl>\n#> 1  1976 86227\n#> 2  1977 91807\n#> 3  1978 94864\n#> 4  1979 96601\n#> 5  1980 96305\n#> 6  1981 98304\n#> # ℹ 36 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\nThis is cumbersome, and prone to error. \n\nAn alternative approach is to embrace the tidy data format. We'll use `pivot_longer()` to convert the data into long format first, and then we'll summarise the data:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_long <- fed_spend_wide %>%\n  pivot_longer(\n    names_to = \"department\",\n    values_to = \"rd_budget_mil\",\n    cols = -year\n  )\n\nhead(fed_spend_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 3\n#>    year department rd_budget_mil\n#>   <dbl> <chr>              <dbl>\n#> 1  1976 DOD                35696\n#> 2  1976 NASA               12513\n#> 3  1976 DOE                10882\n#> 4  1976 HHS                 9226\n#> 5  1976 NIH                 8025\n#> 6  1976 NSF                 2372\n```\n\n\n:::\n:::\n\n\n\n\n\nNow that our data is in long format, we can use the `group_by()` and `summarise()` functions to compute the total R&D spending in each year:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_long %>%\n  group_by(year) %>%\n  summarise(total = sum(rd_budget_mil))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 42 × 2\n#>    year total\n#>   <dbl> <dbl>\n#> 1  1976 86227\n#> 2  1977 91807\n#> 3  1978 94864\n#> 4  1979 96601\n#> 5  1980 96305\n#> 6  1981 98304\n#> # ℹ 36 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\nThis is a much cleaner approach, and it's much less prone to error as we don't need to manually specify each column that we are summing.\n\n### Example 2: Visualizing total spending by department\n\nLet's see how we can do this with our data in wide format:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(fed_spend_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 15\n#>    year   DOD  NASA   DOE   HHS   NIH   NSF  USDA Interior   DOT   EPA   DOC\n#>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>    <dbl> <dbl> <dbl> <dbl>\n#> 1  1976 35696 12513 10882  9226  8025  2372  1837     1152  1142   968   819\n#> 2  1977 37967 12553 13741  9507  8214  2395  1796     1082  1095   966   837\n#> 3  1978 37022 12516 15663 10533  8802  2446  1962     1125  1156  1175   871\n#> 4  1979 37174 13079 15612 10127  9243  2404  2054     1176  1004  1102   952\n#> 5  1980 37005 13837 15226 10045  9093  2407  1887     1082  1048   903   945\n#> 6  1981 41737 13276 14798  9644  8580  2300  1964      990   978   901   829\n#> # ℹ 3 more variables: DHS <dbl>, VA <dbl>, Other <dbl>\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(fed_spend_wide) +\n  geom_col(aes(x = rd_budget_mil, y = department)) +\n  theme_bw() +\n  labs(\n    x = \"R&D Spending ($Millions)\",\n    y = \"Federal Agency\"\n  )\n```\n\n::: {.cell-output .cell-output-error}\n\n```\n#> Error in `geom_col()`:\n#> ! Problem while computing aesthetics.\n#> ℹ Error occurred in the 1st layer.\n#> Caused by error:\n#> ! object 'rd_budget_mil' not found\n```\n\n\n:::\n:::\n\n\n\n\n\nIn wide format, we actually cannot plot the total by department, because there is no `department` variable!\n\nHere we must first convert to long format, and then we can plot the data:\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfed_spend_wide %>%\n  pivot_longer(\n    names_to = \"department\",\n    values_to = \"rd_budget_mil\",\n    cols = -year\n  ) %>%\n  ggplot() +\n  geom_col(aes(x = rd_budget_mil, y = reorder(department, rd_budget_mil))) +\n  theme_bw() +\n  labs(\n    x = \"R&D Spending ($Millions)\",\n    y = \"Federal Agency\"\n  )\n```\n\n::: {.cell-output-display}\n![](figs/fed-spend-bars-long-1.png){fig-align='center' width=576}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}