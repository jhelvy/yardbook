# Tidy Data {#sec-chapter}

```{r}
#| echo: false
#| message: false
#| include: false
source("_common.R")

# Read in data
wildlife_impacts <- read_csv(here::here('data', 'wildlife_impacts.csv'))
milk_production  <- read_csv(here::here('data', 'milk_production.csv'))
tb_rates <- table3
tb_cases <- read_csv(here('data', 'tb_cases.csv'))
milk_production <- read_csv(here('data', 'milk_production.csv'))
fed_spend_long <- read_csv(here('data', 'fed_spend_long.csv'))
fed_spend <- fed_spend_long
fed_spend_wide <- read_csv(here('data', 'fed_spend_wide.csv'))
lotr_words <- read_csv(here('data', 'lotr_words.csv'))
pv_cells <- read_excel(
    here('data', 'pv_cell_production.xlsx'),
    sheet = 'Cell Prod by Country', skip = 2) %>%
  mutate(Year = as.numeric(Year)) %>% 
  filter(!is.na(Year)) 

# Add new variables
wildlife_impacts_orig <- wildlife_impacts
wildlife_impacts <- wildlife_impacts %>%
    mutate(
        weekday_name = wday(incident_date, label = TRUE),
        phase_of_flt = str_to_lower(phase_of_flt),
        phase_of_flt = case_when(
            phase_of_flt %in% c('approach', 'arrival', 'descent',
                                'landing roll') ~ 'arrival',
            phase_of_flt %in% c('climb', 'departure',
                                'take-off run') ~ 'departure',
            TRUE ~ 'other'))
```

> ### Learning Objectives
>
> * Reshape data between long and wide formats.
> * Wrangle and format data, including dealing with messy Excel files.
> * Merge multiple datasets effectively.
> * Clean, organize, and recode variables.
> * Handle and process date data.

## "Wide" and "Long" Formatted Data

### The Data: Federal R&D Spending by Department

```{r, echo=FALSE}
head(fed_spend_wide)
```

### "Wide" format

```{r, echo=FALSE}
head(fed_spend_wide)
```

Dimensions:

```{r, echo=FALSE}
dim(fed_spend_wide)
```

### "Long" format

```{r, echo=FALSE}
head(fed_spend_long)
```

Dimensions:

```{r, echo=FALSE}
dim(fed_spend_long)
```

### Tidy data = "Long" format

- Each **variable** has its own **column**
- Each **observation** has its own **row**

<center>
<img src="images/tidy-data.png" width = "1000">
</center>

### **Do the names describe the values?**

#### **Yes**: "Long" format

```{r, echo=FALSE}
head(fed_spend_long)
```

#### **No**: "Wide" format

```{r, echo=FALSE}
head(select(fed_spend_wide, year:HHS))
```

### Reshaping data

#### `pivot_longer()` and `pivot_wider()`

<center>
<img src="images/tidyr-pivoting.gif" width=530>
</center>

#### From "long" to "wide" with `pivot_wider()`

<center>
<img src="images/tidy-wider.png" width=600>
</center>

```{r}
head(fed_spend_long)
```

```{r}
fed_spend_wide <- fed_spend_long %>%
    pivot_wider(
        names_from = department,
        values_from = rd_budget_mil)

head(fed_spend_wide)
```

#### From "wide" to "long" with `pivot_longer()`

<center>
<img src="images/tidy-longer.png" width=600>
</center>

```{r}
head(fed_spend_wide)
```

```{r}
fed_spend_long <- fed_spend_wide %>%
    pivot_longer( 
        names_to = "department",
        values_to = "rd_budget_mil",
        cols = DOD:Other)

head(fed_spend_long)
```

#### Can also set `cols` by selecting which columns _not_ to use

```{r}
names(fed_spend_wide)
```

```{r}
fed_spend_long <- fed_spend_wide %>%
    pivot_longer(
        names_to = "department", 
        values_to = "rd_budget_mil",
        cols = -year)

head(fed_spend_long)
```

## Tidy data wrangling

What is tidy data wrangling?
(a quick explanation with cute graphics, by [Allison Horst](https://github.com/allisonhorst/stats-illustrations))

<center>
<img src="images/horst_tidydata_1.jpg" width=700>
</center>

<center>
<img src="images/horst_tidydata_2.jpg" width=700>
</center>
<center>
<img src="images/horst_tidydata_3.jpg" width=700>
</center>

Compute the total R&D spending in each year

```{r}
head(fed_spend_wide)
```

Let's compute the total R&D spending in each year

**Approach 1**: Create new `total` by adding each variable

```{r}
fed_spend_wide %>%
  mutate(total = DHS + DOC + DOD + DOE + DOT + EPA + HHS + Interior + NASA + NIH + NSF + Other + USDA + VA) %>%
  select(year, total)
```

**Approach 2**: Reshape first, then summarise

```{r}
fed_spend_long <- fed_spend_wide %>%
    pivot_longer(
        names_to = "department", 
        values_to = "rd_budget_mil",
        cols = -year) 

head(fed_spend_long)
```

```{r}
fed_spend_long %>%
    group_by(year) %>%
    summarise(total = sum(rd_budget_mil))
```

```{r}
total <- fed_spend_wide %>%
    pivot_longer(
        names_to = "department", 
        values_to = "rd_budget_mil",
        cols = -year) %>% 
    group_by(year) %>%
    summarise(total = sum(rd_budget_mil))
```

```{r}
head(total)
```

## Tidy data vizualization

```{r}
head(fed_spend_wide)
```

```{r}
#| error: true
#| fig-show: hide

ggplot(fed_spend_wide) +
  geom_col(aes(x = rd_budget_mil, y = department)) +
  theme_bw() +
  labs(
      x = "R&D Spending ($Millions)",
      y = "Federal Agency"
  )
```

```{r}
#| error: true
#| fig-show: hide

fed_spend_wide %>%
  pivot_longer(
    names_to = "department",
    values_to = "rd_budget_mil",
    cols = -year
  ) %>%
  ggplot() +
  geom_col(aes(x = rd_budget_mil, y = department)) +
  theme_bw() +
  labs(
    x = "R&D Spending ($Millions)",
    y = "Federal Agency"
  )
```

```{r}
#| label: fed-spend-bars-ch4
#| echo: false

ggplot(fed_spend_long) +
  geom_col(aes(x = rd_budget_mil, y = reorder(department, rd_budget_mil)),
           width = 0.7, alpha = 0.8) +
  theme_bw(base_size = 15) +
  labs(x = "R&D Spending ($Millions)",
       y = "Federal Agency")
```
